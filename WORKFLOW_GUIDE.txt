================================================================================
MUSIC THERAPY STUDIO - COMPLETE WORKFLOW GUIDE
================================================================================
Step-by-Step: Login â†’ Profile Creation â†’ Music Recommendation â†’ Dashboard
Version: 2.0 | December 2025

================================================================================
WORKFLOW OVERVIEW
================================================================================

PHASE 1: AUTHENTICATION & LOGIN
--------------------------------

Step 1: User accesses application
  â†’ Lands on login page
  â†’ Selects role: "Therapist" or "Parent"
  â†’ Enters email and password

Step 2: System validates credentials
  â†’ Hashes password with SHA-256 + random salt
  â†’ Compares with stored hash in database
  â†’ Creates session state with user_id, role, email, display_name

Step 3: Redirect based on role
  â†’ Therapist: Full access to profile creation and session management
  â†’ Parent: Read-only access to assigned child profiles


PHASE 2: PROFILE MANAGEMENT
----------------------------

Step 4: Therapist creates child profile
  â†’ Enters child's name
  â†’ Selects date of birth
  â†’ Chooses default target mood (calm, happy, relaxed, energized, focused)
  â†’ Optional: Enters parent/guardian email for invitation

Step 5: System processes profile creation
  â†’ Generates unique profile_id in database
  â†’ Stores profile data: child_name, dob, therapist_id, default_target_mood
  â†’ If parent email provided:
     - Generates unique invitation token (UUID)
     - Sends automated email with webapp link and invitation code
     - Email includes HTML template with step-by-step instructions

Step 6: Parent receives invitation (if applicable)
  â†’ Email arrives with invitation code
  â†’ Parent clicks webapp link
  â†’ Navigates to "Parent Invitation" tab
  â†’ Enters invitation code and creates account
  â†’ System links parent to profile via profile_access table

Step 7: User selects active profile
  â†’ System displays all accessible profiles
  â†’ Shows profile metadata: child name, DOB, target mood
  â†’ User clicks "Open Profile" button
  â†’ System stores active_profile_id in session state


PHASE 3: EMOTION DETECTION SESSION
-----------------------------------

Step 8: Therapist initiates therapy session
  â†’ System offers two detection modes:
     A) Snapshot Mode (recommended, more reliable)
     B) Real-time Video Mode (WebRTC streaming)

Step 9A: Snapshot Mode Process
  â†’ User clicks "Capture Emotion" button
  â†’ Camera captures single frame
  â†’ System sends frame to Hume AI Streaming API
  â†’ Hume analyzes 48 emotion categories
  â†’ Returns top emotion with confidence score
  â†’ System applies threshold (0.2) and normalizes emotion
  â†’ Displays detected emotion to user
  â†’ User confirms or retries capture

Step 9B: Real-time Video Mode Process
  â†’ System initializes WebRTC with 5 Google STUN servers
  â†’ Video stream starts at 10-15 fps
  â†’ Every second: captures frame â†’ sends to Hume AI
  â†’ Detected emotions added to queue
  â†’ System uses majority voting from last 5 detections
  â†’ Updates detected_mood in session state continuously
  â†’ User stops video when ready

Step 10: System validates detection
  â†’ Compares detected emotion with target mood
  â†’ IF detected == target:
     - Display success message: "Already at target mood!"
     - No playlist needed
     - Save session to history
     - Return to profile selection
  â†’ IF detected != target:
     - Proceed to music recommendation phase


PHASE 4: MUSIC RECOMMENDATION GENERATION
-----------------------------------------

Step 11: Calculate emotion transition path
  â†’ Call find_emotion_path(detected_emotion, target_mood)
  â†’ BFS algorithm searches emotion transition graph
  â†’ Ensures minimum 2 transitions (3+ emotions)
  â†’ Example path: sad â†’ melancholic â†’ somber â†’ neutral â†’ content â†’ calm
  â†’ Store emotion_path in session state (used for entire journey)

Step 12: Validate path requirements
  â†’ Check if path length >= 3 emotions
  â†’ If too short: extend with intermediate emotions
  â†’ If no graph path exists: create artificial path with interpolation
  â†’ Display journey overview: "5 transitions required to reach Calm"

Step 13: Extract current transition step
  â†’ current_step = session_state["current_transition_step"] (starts at 0)
  â†’ current_from = emotion_path[current_step]
  â†’ current_to = emotion_path[current_step + 1]
  â†’ Example: Step 1 â†’ sad to melancholic

Step 14: Generate playlist using ML algorithm
  â†’ System calls AdvancedMusicRecommender.generate_playlist()
  â†’ Converts emotions to VAD coordinates (Valence, Arousal, Dominance)
  â†’ Standardizes features using StandardScaler (mean=0, std=1)
  â†’ Applies K-Nearest Neighbors with ball-tree algorithm
  â†’ Finds 50 nearest songs for each transition point
  â†’ Uses cubic easing for smooth emotional progression
  â†’ Selects 5 songs with weighted random selection
  â†’ Applies diversity filter to avoid repetition
  â†’ Stores playlist in session_state["current_playlist"]

Step 15: Display playlist with embedded players
  â†’ Shows transition: "ğŸµ Sad â†’ Melancholic (Step 1 of 5)"
  â†’ Lists 5 songs: track name, artist name
  â†’ Embeds Spotify player for each song
  â†’ User listens to playlist during therapy session


PHASE 5: FEEDBACK & SMART ADAPTATION
-------------------------------------

Step 16: User provides feedback
  â†’ Three options displayed:
     ğŸ˜ Not Effective | ğŸ˜ Neutral | ğŸ˜Š Great
  â†’ User clicks appropriate button

Step 17: System saves session to database
  â†’ INSERT INTO session_history:
     - profile_id
     - start_mood (current_from)
     - target_mood (current_to)
     - feedback_emoji (sad/neutral/happy)
     - playlist_json (all 5 songs)
     - timestamp (auto-generated)

Step 18: Smart feedback processing

  IF feedback == "sad" OR feedback == "neutral":
     â†’ REGENERATE PLAYLIST (stay on same transition)
     â†’ Increment regeneration_count
     â†’ Clear current_playlist from session state
     â†’ Set playlist_regenerated flag to TRUE
     â†’ Generate new playlist with different random_seed
     â†’ Display: "ğŸ”„ Regenerated Playlist (Attempt #2)"
     â†’ Stay on current step (e.g., still on sad â†’ melancholic)
     â†’ New songs will be different due to weighted randomness
  
  IF feedback == "happy":
     â†’ ADVANCE TO NEXT STEP
     â†’ Increment current_transition_step by 1
     â†’ Reset regeneration_count to 0
     â†’ Clear current_playlist from session state
     â†’ Check if journey complete:
        
        IF current_step >= len(emotion_path) - 1:
           â†’ Display: "ğŸ‰ Journey Complete!"
           â†’ Show success message
           â†’ Reset all session variables
           â†’ Redirect to progress dashboard
        
        ELSE:
           â†’ Move to next transition in path
           â†’ current_from = emotion_path[new_step]
           â†’ current_to = emotion_path[new_step + 1]
           â†’ Generate playlist for new transition
           â†’ Display: "âœ… Advancing to Step 2: melancholic â†’ somber"

Step 19: Repeat phases 4-5 until journey complete
  â†’ Continue through all transitions in emotion_path
  â†’ Each step requires positive feedback to advance
  â†’ Negative feedback regenerates current step
  â†’ Journey completes when final target mood reached


PHASE 6: PROGRESS TRACKING & DASHBOARD
---------------------------------------

Step 20: Query session history from database
  â†’ SELECT * FROM session_history WHERE profile_id = ?
  â†’ ORDER BY timestamp DESC
  â†’ Retrieve all completed sessions for the profile

Step 21: Calculate analytics and statistics
  â†’ Total sessions completed
  â†’ Feedback distribution: positive, neutral, negative
  â†’ Success rate = (positive feedback / total sessions) Ã— 100%
  â†’ Most common starting emotions
  â†’ Target mood preferences
  â†’ Average regenerations per journey
  â†’ Timeline of sessions with dates

Step 22: Generate visualizations
  â†’ Mood Distribution Pie Chart (matplotlib)
     - Shows frequency of each starting emotion
     - Color-coded segments
  
  â†’ Feedback Success Rate Bar Chart
     - Green bar: Positive feedback count
     - Gray bar: Neutral feedback count
     - Red bar: Negative feedback count
  
  â†’ Progress Timeline Line Chart
     - X-axis: Date of sessions
     - Y-axis: Cumulative success rate (%)
     - Shows trend over time

Step 23: Display therapist insights
  â†’ Session summary cards with key metrics
  â†’ Highlighted trends: "improving" or "stable"
  â†’ Recommendations for future sessions
  â†’ List of recent playlists with feedback

Step 24: Parent view (read-only mode)
  â†’ Same visualizations and statistics
  â†’ Cannot initiate new sessions
  â†’ Cannot modify profiles
  â†’ Can view all historical playlists
  â†’ Real-time sync with therapist's sessions
  â†’ Shows child's emotional progress over time


PHASE 7: PROFILE UPDATES & MANAGEMENT
--------------------------------------

Step 25: Change target mood (therapist only)
  â†’ Display dropdown with 5 target mood options
  â†’ Select new target mood
  â†’ Click "ğŸ’¾ Update" button
  â†’ System updates database: UPDATE profiles SET default_target_mood = ?
  â†’ If profile is active: clear emotion_path to force recalculation
  â†’ Display success message: "âœ… Target mood changed to Happy"

Step 26: Delete profile (therapist only)
  â†’ Click "ğŸ—‘ï¸ Delete" button on profile card
  â†’ System displays confirmation dialog
  â†’ Warning: "This will permanently delete all session history"
  â†’ User confirms or cancels
  â†’ If confirmed:
     - Cascading delete: session_history, profile_access, parent_invites
     - DELETE FROM profiles WHERE id = ? AND therapist_id = ?
     - Display success message
     - Clear active_profile if it was deleted

Step 27: Email invitations (automated)
  â†’ When profile created with parent email:
     - System generates invitation code (UUID)
     - Sends HTML email with:
       * Webapp link (https://music-therapy-aiml-tmsl.streamlit.app/)
       * Invitation code displayed prominently
       * Step-by-step instructions
       * Benefits list
       * Therapist name personalization
     - Email uses SMTP with TLS (Gmail, Outlook, Yahoo supported)


================================================================================
SESSION STATE MANAGEMENT
================================================================================

Key Variables Tracked:
----------------------
session_state["authenticated"] = TRUE/FALSE
session_state["user_id"] = Integer (therapist or parent ID)
session_state["user_role"] = "therapist" or "parent"
session_state["user_email"] = String
session_state["user_display_name"] = String

session_state["active_profile_id"] = Integer
session_state["detected_mood"] = String (e.g., "sad")

session_state["emotion_path"] = List (e.g., ["sad", "melancholic", "somber", "calm"])
session_state["current_transition_step"] = Integer (0 to len(path)-2)
session_state["current_from"] = String (start emotion of current step)
session_state["current_to"] = String (target emotion of current step)

session_state["current_playlist"] = DataFrame (5 songs)
session_state["regeneration_count"] = Integer (0, 1, 2, ...)
session_state["playlist_regenerated"] = TRUE/FALSE (flag for display)


================================================================================
DATA FLOW SUMMARY
================================================================================

User Login
   â†“
Profile Selection/Creation
   â†“
Emotion Detection (Hume AI / OpenCV)
   â†“
Same Mood Check â†’ [YES] Success Message, Return
   â†“ [NO]
Path Finding (BFS with min 2 transitions)
   â†“
Playlist Generation (KNN + Cubic Easing)
   â†“
Display 5 Songs (Spotify Embeds)
   â†“
Feedback Collection
   â†“
Decision Point:
   â”œâ”€ Negative/Neutral â†’ Regenerate Playlist (stay on step)
   â””â”€ Positive â†’ Advance to Next Step
         â†“
   Check if Complete â†’ [NO] Generate Next Playlist
         â†“ [YES]
   Journey Complete â†’ Progress Dashboard


================================================================================
USER ROLES & PERMISSIONS
================================================================================

Therapist Permissions:
- Create child profiles âœ“
- Conduct therapy sessions âœ“
- Generate playlists âœ“
- Provide feedback âœ“
- Invite parents âœ“
- View progress dashboard âœ“
- Update target mood âœ“
- Delete profiles âœ“

Parent Permissions:
- View assigned child profiles âœ“
- View session history (read-only) âœ“
- View progress dashboard (read-only) âœ“
- Cannot create profiles âœ—
- Cannot conduct sessions âœ—
- Cannot modify settings âœ—


================================================================================
KEY FEATURES EXPLAINED
================================================================================

1. SAME MOOD DETECTION
   - If detected emotion matches target mood, no playlist needed
   - Saves time and recognizes child is already in desired state
   - Session still recorded in history

2. MINIMUM 2 TRANSITIONS (ISO PRINCIPLE)
   - Every journey has at least 3 emotions (2 transitions)
   - Ensures gradual therapeutic progression
   - Prevents abrupt emotional jumps

3. SMART FEEDBACK LOOP
   - Negative feedback â†’ Regenerate with different songs
   - Positive feedback â†’ Advance to next transition
   - Allows therapist to adjust in real-time

4. PLAYLIST REGENERATION
   - Uses different random seed each time
   - Weighted selection ensures variety (~10% overlap)
   - Same therapeutic goal, different musical approach

5. MULTI-STEP JOURNEYS
   - Complex transitions split into manageable steps
   - Example: sad â†’ calm requires 5 transitions (6 emotions)
   - Each step gets dedicated 5-song playlist

6. PROGRESS TRACKING
   - All sessions saved to database
   - Visualizations show trends over time
   - Success rate calculated automatically

7. COLLABORATIVE CARE
   - Parents receive automated invitations
   - Shared view of child's progress
   - Therapist maintains control of treatment


================================================================================
END OF WORKFLOW GUIDE
================================================================================
